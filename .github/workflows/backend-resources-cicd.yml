name: Update AWS Backend Resources

on:
  push:
    branches: [ main ]
    paths:
      - "infrastructure/resources/backend.yml"
      - ".github/workflows/backend-resources-cicd.yml"
      - "src/lambda-functions/code/**"

env:
  S3_CODE_BUCKET_NAME: crc-backend-lambda-code-bucket

jobs:
  deploy-backend-infrastructure:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Deployment Timestamp And Temp Path
        id: envs
        run: |
          echo "time=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "zip_path=$RUNNER_TEMP/lambda_zips" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::472387458718:role/GitHubActions_Backend_Resources
          aws-region: us-east-1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Unit Tests
        run: |
          echo "Starting Python Unit Tests..."
          cd src
          ls
          cd lambda-functions
          ls
          cd test
          ls
          python -m unittest discover
          echo "All unit tests passed successfully."

      - name: Install cfn-policy-validator
        run: pip install cfn-policy-validator

      - name: Ensure S3 Code Deployment Bucket Exists And Is Securely Configured
        run: |
          echo "1. Creating S3 bucket ${S3_CODE_BUCKET_NAME} if it does not exist..."
          aws s3 mb s3://${S3_CODE_BUCKET_NAME} || true

          echo "2. Applying Public Access Block (Block all public access)..."
          aws s3api put-public-access-block \
            --bucket ${S3_CODE_BUCKET_NAME} \
            --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

          echo "3. Enforcing BucketOwnerEnforced ownership controls..."
          aws s3api put-bucket-ownership-controls \
            --bucket ${S3_CODE_BUCKET_NAME} \
            --ownership-controls '{"Rules": [{"ObjectOwnership": "BucketOwnerEnforced"}]}'

          echo "4. Enforcing Default Encryption (SSE-AES256)..."
          aws s3api put-bucket-encryption \
            --bucket ${S3_CODE_BUCKET_NAME} \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

          echo "5. Enabling Versioning..."
          aws s3api put-bucket-versioning \
            --bucket ${S3_CODE_BUCKET_NAME} \
            --versioning-configuration Status=Enabled

          cat > $RUNNER_TEMP/lifecycle.json <<'EOF'
          {
            "Rules": [
              {
                "ID": "ExpireOldVersions",
                "Status": "Enabled",
                "Filter": { "Prefix": "" },
                "NoncurrentVersionExpiration": { "NoncurrentDays": 30 }
              },
              {
                "ID": "AbortIncompleteUploads",
                "Status": "Enabled",
                "Filter": { "Prefix": "" },
                "AbortIncompleteMultipartUpload": { "DaysAfterInitiation": 7 }
              }
            ]
          }
          EOF

          aws s3api put-bucket-lifecycle-configuration \
            --bucket ${S3_CODE_BUCKET_NAME} \
            --lifecycle-configuration file://$RUNNER_TEMP/lifecycle.json

      - name: Prepare And Zip Code
        env:
          DEPLOY_TIME: ${{ steps.envs.outputs.time }}
          TEMP_PATH: ${{ steps.envs.outputs.zip_path }} 
        run: |
          mkdir -p $TEMP_PATH
          zip -j $TEMP_PATH/visitor-counter-code-${DEPLOY_TIME}.zip src/lambda-functions/code/visitor-counter-code.py
          zip -j $TEMP_PATH/slack-webhook-code-${DEPLOY_TIME}.zip src/lambda-functions/code/slack-webhook-code.py

      - name: Upload Zips To S3 Bucket
        env:
          DEPLOY_TIME: ${{ steps.envs.outputs.time }}
          TEMP_PATH: ${{ steps.envs.outputs.zip_path }} 
        run: |
          aws s3 cp $TEMP_PATH/visitor-counter-code-${DEPLOY_TIME}.zip s3://${S3_CODE_BUCKET_NAME}/visitor-counter-code-${DEPLOY_TIME}.zip
          aws s3 cp $TEMP_PATH/slack-webhook-code-${DEPLOY_TIME}.zip s3://${S3_CODE_BUCKET_NAME}/slack-webhook-code-${DEPLOY_TIME}.zip
          echo "Uploaded: s3://${S3_CODE_BUCKET_NAME}/.../${DEPLOY_TIME}.zip"

      - name: Validate Template Syntax
        run: |
          aws cloudformation validate-template \
            --template-body file://infrastructure/resources/backend.yml

      - name: Validate IAM Policy
        run: |
          cfn-policy-validator validate \
            --template-path infrastructure/resources/backend.yml \
            --region us-east-1

      - name: Deploy Backend Infrastructure
        env:
          DEPLOY_TIME: ${{ steps.envs.outputs.time }}
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/resources/backend.yml \
            --stack-name backend-resources \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              LambdaCodeS3Bucket="${S3_CODE_BUCKET_NAME}" \
              VisitorCounterLambdaS3Key="visitor-counter-code-${DEPLOY_TIME}.zip" \
              SlackWebhookLambdaS3Key="slack-webhook-code-${DEPLOY_TIME}.zip"

      - name: Debug CloudFormation Failure
        if: failure()
        run: |
          aws cloudformation describe-stack-events \
            --stack-name backend-resources \
            --query "StackEvents[?ResourceStatus=='CREATE_FAILED' || ResourceStatus=='REVIEW_IN_PROGRESS' || ResourceStatus=='ROLLBACK_IN_PROGRESS'].[LogicalResourceId, ResourceStatus, ResourceStatusReason]" \
            --output table