name: Update AWS Frontend Website

on:
  push:
    branches: [ main ]
    paths:
      - "bucket-content/**"
      - ".github/workflows/frontend-website-cicd.yml"

env:
  RESUME_BASE_URL: https://best-resume-ever.com
  RESUME_API_URL: https://dzinfmbutk.execute-api.us-east-1.amazonaws.com/prod/visitor

jobs:
  sync-website-to-s3:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::472387458718:role/GitHubActions_Frontend_Website
          aws-region: us-east-1

      - name: Sync Bucket Content Folder To S3
        run: |
          echo "Syncing bucket-content/ folder to S3 bucket..."
          aws s3 sync bucket-content/ s3://crc-frontend-bucket/ \
            --delete \
            --acl bucket-owner-full-control \
            --no-progress

      - name: Get CloudFront Distribution IDs For The Domain
        id: cf
        run: |
          DIST_IDS=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Aliases.Items, 'best-resume-ever.com')].Id" \
            --output text)
          echo "Found distribution IDs: $DIST_IDS"
          echo "distribution_ids=$DIST_IDS" >> $GITHUB_ENV

      - name: Invalidate CloudFront Cache
        if: env.distribution_ids != ''
        run: |
          for DIST_ID in $distribution_ids; do
            echo "Creating invalidation for distribution $DIST_ID..."
            aws cloudfront create-invalidation \
              --distribution-id $DIST_ID \
              --paths "/*"
          done
        shell: bash

      - name: Skip CloudFront Invalidation If Not Found
        if: env.distribution_ids == ''
        run: echo "No CloudFront distribution found for best-resume-ever.com. Skipping invalidation."

  e2e-tests:
    runs-on: ubuntu-latest
    needs: sync-website-to-s3
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Cypress Dependencies
        run: npm install

      - name: Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        env:
          CYPRESS_API_URL: ${{ env.RESUME_API_URL }}
          CYPRESS_BASE_URL: ${{ env.RESUME_BASE_URL }}